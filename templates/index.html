<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>My Linear Dashboard</title>
  <style>
    :root {
      --bg: #0f1419;
      --surface: #1a2332;
      --border: #2d3a4d;
      --text: #e6edf3;
      --text-muted: #8b949e;
      --link: #58a6ff;
      --priority-urgent: #f85149;
      --priority-high: #db6d28;
      --priority-medium: #d29922;
      --priority-low: #3fb950;
      --priority-none: #8b949e;
    }
    * { box-sizing: border-box; }
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
      background: var(--bg);
      color: var(--text);
      margin: 0;
      padding: 1rem 2rem 2rem;
      min-height: 100vh;
    }
    header {
      display: flex;
      align-items: center;
      gap: 1.5rem;
      flex-wrap: wrap;
      margin-bottom: 1.5rem;
      padding-bottom: 1rem;
      border-bottom: 1px solid var(--border);
    }
    h1 { margin: 0; font-size: 1.5rem; font-weight: 600; }
    .last-fetched { color: var(--text-muted); font-size: 0.875rem; }
    button {
      background: var(--surface);
      color: var(--text);
      border: 1px solid var(--border);
      padding: 0.5rem 1rem;
      border-radius: 6px;
      cursor: pointer;
      font-size: 0.875rem;
    }
    button:hover { background: var(--border); }
    button.primary { background: var(--link); border-color: var(--link); color: #fff; }
    button.primary:hover { opacity: 0.9; }
    .controls {
      display: flex;
      gap: 1rem;
      flex-wrap: wrap;
      align-items: center;
      margin-bottom: 1rem;
    }
    .controls label { font-size: 0.875rem; color: var(--text-muted); }
    select, input[type="text"] {
      background: var(--surface);
      color: var(--text);
      border: 1px solid var(--border);
      padding: 0.4rem 0.6rem;
      border-radius: 4px;
      font-size: 0.875rem;
    }
    input[type="text"] { min-width: 200px; }
    table {
      width: 100%;
      border-collapse: collapse;
      font-size: 0.875rem;
    }
    th, td {
      padding: 0.6rem 0.75rem;
      text-align: left;
      border-bottom: 1px solid var(--border);
    }
    th { color: var(--text-muted); font-weight: 500; }
    tr.completed { opacity: 0.75; }
    tr.completed td { color: var(--text-muted); }
    a { color: var(--link); text-decoration: none; }
    a:hover { text-decoration: underline; }
    .badge {
      display: inline-block;
      padding: 0.2rem 0.5rem;
      border-radius: 4px;
      font-size: 0.75rem;
      font-weight: 500;
    }
    .priority-0 { background: var(--priority-none); color: var(--bg); }
    .priority-1 { background: var(--priority-urgent); color: #fff; }
    .priority-2 { background: var(--priority-high); color: #fff; }
    .priority-3 { background: var(--priority-medium); color: #000; }
    .priority-4 { background: var(--priority-low); color: #000; }
    .notes-cell { cursor: pointer; }
    .notes-preview {
      max-width: 220px;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
      color: var(--text-muted);
    }
    .notes-cell:hover .notes-preview { color: var(--link); text-decoration: underline; }
    .modal-overlay {
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.6);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 100;
    }
    .modal-overlay.open { display: flex; }
    .modal {
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: 8px;
      padding: 1.5rem;
      min-width: 400px;
      max-width: 90vw;
    }
    .modal h2 { margin: 0 0 1rem; font-size: 1.1rem; }
    .modal textarea {
      width: 100%;
      min-height: 100px;
      background: var(--bg);
      color: var(--text);
      border: 1px solid var(--border);
      border-radius: 4px;
      padding: 0.5rem;
      font-family: inherit;
      font-size: 0.875rem;
      margin-bottom: 1rem;
      resize: vertical;
    }
    .modal .field { margin-bottom: 0.75rem; }
    .modal .field label { display: block; font-size: 0.75rem; color: var(--text-muted); margin-bottom: 0.25rem; }
    .modal-actions { display: flex; justify-content: flex-end; gap: 0.5rem; margin-top: 1rem; }
    .loading, .empty { text-align: center; color: var(--text-muted); padding: 2rem; }
    .error { color: var(--priority-urgent); padding: 0.5rem 0; font-size: 0.875rem; }
    select.flat { border: none; background: transparent; color: inherit; cursor: pointer; padding: 0.2rem; }
    .tabs {
      display: flex;
      gap: 0;
      margin-bottom: 1rem;
      border-bottom: 1px solid var(--border);
    }
    .tab {
      background: transparent;
      border: none;
      border-bottom: 2px solid transparent;
      margin-bottom: -1px;
      padding: 0.5rem 1rem;
      font-size: 0.875rem;
      color: var(--text-muted);
      cursor: pointer;
    }
    .tab:hover { color: var(--text); }
    .tab.active {
      color: var(--link);
      border-bottom-color: var(--link);
      font-weight: 500;
    }
    .filter-btn-wrap { position: relative; display: inline-block; }
    .filter-btn-wrap .filter-badge {
      position: absolute;
      top: -4px;
      right: -4px;
      min-width: 16px;
      height: 16px;
      padding: 0 4px;
      border-radius: 8px;
      background: var(--priority-urgent);
      color: #fff;
      font-size: 0.7rem;
      font-weight: 600;
      display: none;
      align-items: center;
      justify-content: center;
    }
    .filter-btn-wrap .filter-badge.visible { display: flex; }
    .filter-popover {
      position: absolute;
      top: 100%;
      left: 0;
      margin-top: 4px;
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: 8px;
      padding: 1rem;
      min-width: 280px;
      max-width: 90vw;
      box-shadow: 0 8px 24px rgba(0,0,0,0.4);
      z-index: 50;
      display: none;
    }
    .filter-popover.open { display: block; }
    .filter-popover .filter-section { margin-bottom: 0.75rem; }
    .filter-popover .filter-section label { display: block; font-size: 0.75rem; color: var(--text-muted); margin-bottom: 0.25rem; }
    .filter-popover .filter-actions { display: flex; justify-content: flex-end; gap: 0.5rem; margin-top: 1rem; }
    .filter-popover input[type="date"] { background: var(--bg); color: var(--text); border: 1px solid var(--border); padding: 0.35rem; border-radius: 4px; font-size: 0.875rem; }
    .filter-popover .checkbox-list { max-height: 120px; overflow-y: auto; }
    .filter-popover .checkbox-list label { display: flex; align-items: center; gap: 0.5rem; font-size: 0.875rem; color: var(--text); margin: 0.25rem 0; cursor: pointer; }
    .filter-popover .checkbox-list input[type="checkbox"] { margin: 0; }
    .th-sortable { cursor: pointer; user-select: none; white-space: nowrap; }
    .th-sortable:hover { color: var(--text); }
    .th-sortable .sort-indicator { margin-left: 0.25rem; opacity: 0.7; }
  </style>
</head>
<body>
  <header>
    <h1>My Linear Dashboard</h1>
    <button type="button" id="refresh-btn">Refresh</button>
    <span class="last-fetched" id="last-fetched">Last fetched: —</span>
  </header>

  <div class="tabs" role="tablist">
    <button type="button" class="tab active" id="tab-active" role="tab" aria-selected="true">Active</button>
    <button type="button" class="tab" id="tab-completed" role="tab" aria-selected="false">Completed</button>
  </div>
  <div class="controls">
    <div class="filter-btn-wrap">
      <button type="button" id="filter-btn" title="Filter issues">
        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polygon points="22 3 2 3 10 12.46 10 19 14 21 14 12.46 22 3"/></svg>
      </button>
      <span class="filter-badge" id="filter-badge" aria-hidden="true"></span>
      <div class="filter-popover" id="filter-popover">
      <div class="filter-section">
        <label>Linear Updated — From</label>
        <input type="date" id="filter-date-from">
      </div>
      <div class="filter-section">
        <label>Linear Updated — To</label>
        <input type="date" id="filter-date-to">
      </div>
      <div class="filter-section">
        <label>Linear Status</label>
        <div class="checkbox-list" id="filter-linear-status"></div>
      </div>
      <div class="filter-section">
        <label>Linear Priority</label>
        <div class="checkbox-list" id="filter-linear-priority"></div>
      </div>
      <div class="filter-section">
        <label>Personal Priority</label>
        <select id="filter-personal-priority">
          <option value="all">All</option>
          <option value="set">Set</option>
          <option value="unset">Unset</option>
        </select>
      </div>
      <div class="filter-section">
        <label>Personal Status</label>
        <div class="checkbox-list" id="filter-personal-status"></div>
      </div>
      <div class="filter-actions">
        <button type="button" id="filter-clear">Clear All</button>
        <button type="button" id="filter-apply" class="primary">Apply</button>
      </div>
      </div>
    </div>
    <label>Search:</label>
    <input type="text" id="search" placeholder="Title or notes...">
  </div>

  <div id="error" class="error" style="display: none;"></div>
  <div id="loading" class="loading" style="display: none;">Loading…</div>
  <div id="empty" class="empty" style="display: none;">No issues match filters.</div>
  <table id="issues-table" style="display: none;">
    <thead>
      <tr>
        <th>Issue</th>
        <th class="th-sortable" data-sort-column="linear_status" id="th-linear-status">Linear status <span class="sort-indicator"></span></th>
        <th class="th-sortable" data-sort-column="linear_priority" id="th-linear-priority">Linear priority <span class="sort-indicator"></span></th>
        <th class="th-sortable" data-sort-column="personal_priority" id="th-personal-priority">Personal priority <span class="sort-indicator"></span></th>
        <th class="th-sortable" data-sort-column="personal_status" id="th-personal-status">Personal status <span class="sort-indicator"></span></th>
        <th>Notes</th>
        <th class="th-sortable" data-sort-column="updated_at" id="th-updated-at">Linear Updated <span class="sort-indicator"></span></th>
        <th class="th-sortable" data-sort-column="last_updated" id="th-last-updated">My Last Edit <span class="sort-indicator"></span></th>
      </tr>
    </thead>
    <tbody id="issues-body"></tbody>
  </table>

  <div class="modal-overlay" id="modal">
    <div class="modal">
      <h2 id="modal-title">Edit overlay</h2>
      <div class="field">
        <label>Notes</label>
        <textarea id="modal-notes" placeholder="Private notes..."></textarea>
      </div>
      <div class="field">
        <label>Personal priority (position in list)</label>
        <select id="modal-personal-priority">
          <option value="">Not set</option>
        </select>
      </div>
      <div class="field">
        <label>Personal status</label>
        <select id="modal-personal-status"></select>
      </div>
      <div class="modal-actions">
        <button type="button" id="modal-cancel">Cancel</button>
        <button type="button" id="modal-save" class="primary">Save</button>
      </div>
    </div>
  </div>

  <script>
    (function() {
      let allIssues = [];
      let priorityLabels = {};
      let personalStatusOptions = [];
      let editingIssueId = null;
      let filterConfig = {
        date_from: '',
        date_to: '',
        linear_statuses: [],
        linear_priorities: [],
        personal_priority_filter: 'all',
        personal_statuses: []
      };
      let sortColumn = 'personal_priority';
      let sortDir = 'asc';

      const lastFetchedEl = document.getElementById('last-fetched');
      const refreshBtn = document.getElementById('refresh-btn');
      const tabActiveEl = document.getElementById('tab-active');
      const tabCompletedEl = document.getElementById('tab-completed');
      const searchEl = document.getElementById('search');
      const errorEl = document.getElementById('error');
      const loadingEl = document.getElementById('loading');
      const emptyEl = document.getElementById('empty');
      const tableEl = document.getElementById('issues-table');
      const tbody = document.getElementById('issues-body');
      const modalEl = document.getElementById('modal');
      const filterBtn = document.getElementById('filter-btn');
      const filterBadge = document.getElementById('filter-badge');
      const filterPopover = document.getElementById('filter-popover');
      const filterDateFrom = document.getElementById('filter-date-from');
      const filterDateTo = document.getElementById('filter-date-to');
      const filterLinearStatus = document.getElementById('filter-linear-status');
      const filterLinearPriority = document.getElementById('filter-linear-priority');
      const filterPersonalPriority = document.getElementById('filter-personal-priority');
      const filterPersonalStatus = document.getElementById('filter-personal-status');
      const filterClearBtn = document.getElementById('filter-clear');
      const filterApplyBtn = document.getElementById('filter-apply');
      const modalTitle = document.getElementById('modal-title');
      const modalNotes = document.getElementById('modal-notes');
      const modalPersonalPriority = document.getElementById('modal-personal-priority');
      const modalPersonalStatus = document.getElementById('modal-personal-status');
      const modalCancel = document.getElementById('modal-cancel');
      const modalSave = document.getElementById('modal-save');

      function showError(msg) {
        errorEl.textContent = msg;
        errorEl.style.display = 'block';
      }
      function hideError() {
        errorEl.style.display = 'none';
      }
      function setLoading(on) {
        loadingEl.style.display = on ? 'block' : 'none';
        if (!on) tableEl.style.display = 'table';
      }

      function formatDate(iso) {
        if (!iso) return '—';
        try {
          const d = new Date(iso);
          return d.toLocaleDateString(undefined, { dateStyle: 'short' });
        } catch (_) { return iso; }
      }

      function formatDateTime(iso) {
        if (!iso) return '—';
        try {
          const d = new Date(iso);
          return d.toLocaleString(undefined, { dateStyle: 'short', timeStyle: 'short' });
        } catch (_) { return iso; }
      }

      function formatAbsoluteDate(iso) {
        if (!iso) return '—';
        try {
          const d = new Date(iso);
          return d.toLocaleDateString(undefined, { year: 'numeric', month: 'short', day: 'numeric' });
        } catch (_) { return iso; }
      }

      function formatRelativeDate(iso) {
        if (!iso) return null;
        try {
          const d = new Date(iso);
          const now = new Date();
          const today = new Date(now.getFullYear(), now.getMonth(), now.getDate());
          const yesterday = new Date(today);
          yesterday.setDate(yesterday.getDate() - 1);
          const dDate = new Date(d.getFullYear(), d.getMonth(), d.getDate());
          if (dDate.getTime() === today.getTime()) return 'today';
          if (dDate.getTime() === yesterday.getTime()) return 'yesterday';
          const diffDays = Math.round((today - dDate) / (1000 * 60 * 60 * 24));
          if (diffDays > 0 && diffDays <= 7) return diffDays + ' days ago';
          return formatAbsoluteDate(iso);
        } catch (_) { return iso; }
      }

      function linearPriorityLabel(p) {
        return priorityLabels[p] != null ? priorityLabels[p] : '—';
      }

      function clientSortKeyLinearPriority(p) {
        var v = p != null ? p : 0;
        return v === 0 ? 5 : v;
      }
      function clientSortKeyPersonalPriority(issue, asc) {
        var p = issue.personal_priority;
        if (p == null || p === '') return asc ? 1e9 : -1e9;
        return p;
      }
      function clientSortKeyLastUpdated(issue, asc) {
        var lu = issue.last_updated || '';
        if (!lu) return asc ? 1 : 0;
        return asc ? lu : lu;
      }
      function sortIssuesClientSide(list, column, dir) {
        var asc = dir === 'asc';
        var arr = list.slice();
        if (column === 'linear_status') {
          arr.sort(function(a, b) {
            var sa = (a.linear_status || '').localeCompare(b.linear_status || '');
            return asc ? sa : -sa;
          });
        } else if (column === 'linear_priority') {
          arr.sort(function(a, b) {
            var ka = clientSortKeyLinearPriority(a.linear_priority);
            var kb = clientSortKeyLinearPriority(b.linear_priority);
            return asc ? (ka - kb) : (kb - ka);
          });
        } else if (column === 'personal_priority') {
          arr.sort(function(a, b) {
            var ka = clientSortKeyPersonalPriority(a, asc);
            var kb = clientSortKeyPersonalPriority(b, asc);
            return ka - kb;
          });
        } else if (column === 'personal_status') {
          arr.sort(function(a, b) {
            var sa = (a.personal_status || '').localeCompare(b.personal_status || '');
            return asc ? sa : -sa;
          });
        } else if (column === 'updated_at') {
          arr.sort(function(a, b) {
            var ua = a.updated_at || '';
            var ub = b.updated_at || '';
            var c = ua.localeCompare(ub);
            return asc ? c : -c;
          });
        } else if (column === 'last_updated') {
          arr.sort(function(a, b) {
            var ua = a.last_updated || '';
            var ub = b.last_updated || '';
            if (!ua && !ub) return 0;
            if (!ua) return asc ? 1 : -1;
            if (!ub) return asc ? -1 : 1;
            var c = ua.localeCompare(ub);
            return asc ? c : -c;
          });
        }
        return arr;
      }

      function filteredAndSortedIssues() {
        var q = (searchEl.value || '').trim().toLowerCase();
        var list = !q ? allIssues : allIssues.filter(function(issue) {
          var identifier = (issue.identifier || issue.id || '').toString().toLowerCase();
          var title = (issue.title || '').toLowerCase();
          var notes = (issue.notes || '').toLowerCase();
          return identifier.includes(q) || title.includes(q) || notes.includes(q);
        });
        return sortIssuesClientSide(list, sortColumn, sortDir);
      }

      function updateSortIndicators() {
        document.querySelectorAll('.th-sortable .sort-indicator').forEach(function(span) { span.textContent = ''; });
        var th = document.querySelector('.th-sortable[data-sort-column="' + sortColumn + '"]');
        if (th) {
          var ind = th.querySelector('.sort-indicator');
          if (ind) ind.textContent = sortDir === 'asc' ? ' ▲' : ' ▼';
        }
      }

      function renderTable() {
        const list = filteredAndSortedIssues();
        tbody.innerHTML = '';
        if (list.length === 0) {
          emptyEl.style.display = 'block';
          tableEl.style.display = 'none';
          return;
        }
        emptyEl.style.display = 'none';
        list.forEach(function(issue) {
          const tr = document.createElement('tr');
          if (issue.is_completed) tr.classList.add('completed');
          const notesFirstLine = (issue.notes || '').split('\n')[0].trim();
          const notesPreview = notesFirstLine ? notesFirstLine.substring(0, 60) + (notesFirstLine.length > 60 ? '…' : '') : '';
          const priorityClass = 'priority-' + (issue.linear_priority != null ? issue.linear_priority : 0);
          tr.innerHTML =
            '<td><a href="' + (issue.url || '#') + '" target="_blank" rel="noopener">' + escapeHtml(issue.identifier || issue.id) + ': ' + escapeHtml(issue.title || '') + '</a></td>' +
            '<td>' + escapeHtml(issue.linear_status || '—') + '</td>' +
            '<td><span class="badge ' + priorityClass + '">' + escapeHtml(linearPriorityLabel(issue.linear_priority)) + '</span></td>' +
            '<td>' + (issue.personal_priority != null && issue.personal_priority !== '' ? issue.personal_priority : 'Not set') + '</td>' +
            '<td>' + escapeHtml(issue.personal_status || 'No status') + '</td>' +
            '<td class="notes-cell"><span class="notes-preview" data-issue-id="' + escapeHtml(issue.identifier || issue.id) + '">' + (notesPreview || 'Add notes…') + '</span></td>' +
            (function() {
              const linearUpdated = issue.updated_at;
              const rel = formatRelativeDate(linearUpdated);
              const tooltip = formatDateTime(linearUpdated);
              const titleAttr = tooltip ? ' title="' + escapeHtml(tooltip) + '"' : '';
              return '<td' + titleAttr + '>' + (rel || '—') + '</td>';
            })() +
            (function() {
              const myEdit = issue.last_updated;
              if (!myEdit) return '<td>—</td>';
              const rel = formatRelativeDate(myEdit);
              const tooltip = formatDateTime(myEdit);
              return '<td title="' + escapeHtml(tooltip) + '">' + escapeHtml(rel) + '</td>';
            })();
          tbody.appendChild(tr);
        });
      }

      function escapeHtml(s) {
        if (s == null) return '';
        const div = document.createElement('div');
        div.textContent = s;
        return div.innerHTML;
      }

      function openModal(issueId) {
        const issue = allIssues.find(function(i) { return (i.identifier || i.id) === issueId; });
        if (!issue) return;
        editingIssueId = issueId;
        modalTitle.textContent = (issue.identifier || issueId) + ': ' + (issue.title || '');
        modalNotes.value = issue.notes || '';
        var count = allIssues.filter(function(i) { return i.personal_priority != null && i.personal_priority !== ''; }).length;
        var maxPos = Math.max(count + 1, 1);
        modalPersonalPriority.innerHTML = '<option value="">Not set</option>';
        for (var p = 1; p <= maxPos; p++) {
          var opt = document.createElement('option');
          opt.value = String(p);
          opt.textContent = p === 1 ? '1 (first)' : (p === maxPos ? p + ' (last)' : String(p));
          modalPersonalPriority.appendChild(opt);
        }
        modalPersonalPriority.value = issue.personal_priority != null && issue.personal_priority !== '' ? String(issue.personal_priority) : '';
        modalPersonalStatus.value = issue.personal_status || '';
        modalEl.classList.add('open');
      }

      function closeModal() {
        modalEl.classList.remove('open');
        editingIssueId = null;
      }

      function loadMeta() {
        fetch('/api/priority-labels').then(function(r) { return r.json(); }).then(function(labels) {
          priorityLabels = labels;
        }).catch(function() {});
        fetch('/api/personal-status-options').then(function(r) { return r.json(); }).then(function(opts) {
          personalStatusOptions = opts || [];
          modalPersonalStatus.innerHTML = personalStatusOptions.map(function(o) {
            return '<option value="' + escapeHtml(o) + '">' + escapeHtml(o || 'No status') + '</option>';
          }).join('');
        }).catch(function() {});
      }

      function getFilter() {
        return tabActiveEl.classList.contains('active') ? 'active' : 'completed';
      }

      function countActiveFilterCategories(cfg) {
        var n = 0;
        if ((cfg.date_from || '') !== '' || (cfg.date_to || '') !== '') n++;
        if ((cfg.linear_statuses || []).length > 0) n++;
        if ((cfg.linear_priorities || []).length > 0) n++;
        if ((cfg.personal_priority_filter || 'all') !== 'all') n++;
        if ((cfg.personal_statuses || []).length > 0) n++;
        return n;
      }

      function buildFilterQueryString(cfg) {
        var parts = [];
        if ((cfg.date_from || '').trim()) parts.push('date_from=' + encodeURIComponent(cfg.date_from.trim()));
        if ((cfg.date_to || '').trim()) parts.push('date_to=' + encodeURIComponent(cfg.date_to.trim()));
        (cfg.linear_statuses || []).forEach(function(s) { parts.push('linear_status=' + encodeURIComponent(s)); });
        (cfg.linear_priorities || []).forEach(function(p) { parts.push('linear_priority=' + encodeURIComponent(String(p))); });
        if ((cfg.personal_priority_filter || 'all') !== 'all') parts.push('personal_priority_filter=' + encodeURIComponent(cfg.personal_priority_filter));
        (cfg.personal_statuses || []).forEach(function(s) { parts.push('personal_status=' + encodeURIComponent(s)); });
        return parts.length ? '&' + parts.join('&') : '';
      }

      function updateFilterBadge() {
        var n = countActiveFilterCategories(filterConfig);
        filterBadge.textContent = n;
        if (n > 0) filterBadge.classList.add('visible'); else filterBadge.classList.remove('visible');
      }

      function syncPopoverFromFilterConfig() {
        filterDateFrom.value = filterConfig.date_from || '';
        filterDateTo.value = filterConfig.date_to || '';
        filterPersonalPriority.value = filterConfig.personal_priority_filter || 'all';
        var statusSet = {};
        (filterConfig.linear_statuses || []).forEach(function(s) { statusSet[s] = true; });
        filterLinearStatus.querySelectorAll('input[type="checkbox"]').forEach(function(cb) {
          cb.checked = statusSet[cb.value] || false;
        });
        var priSet = {};
        (filterConfig.linear_priorities || []).forEach(function(p) { priSet[String(p)] = true; });
        filterLinearPriority.querySelectorAll('input[type="checkbox"]').forEach(function(cb) {
          cb.checked = priSet[cb.value] || false;
        });
        var psSet = {};
        (filterConfig.personal_statuses || []).forEach(function(s) { psSet[s === null ? '' : s] = true; });
        filterPersonalStatus.querySelectorAll('input[type="checkbox"]').forEach(function(cb) {
          cb.checked = psSet[cb.value] || false;
        });
      }

      function syncFilterConfigFromPopover() {
        filterConfig.date_from = (filterDateFrom.value || '').trim();
        filterConfig.date_to = (filterDateTo.value || '').trim();
        filterConfig.personal_priority_filter = filterPersonalPriority.value || 'all';
        filterConfig.linear_statuses = [];
        filterLinearStatus.querySelectorAll('input[type="checkbox"]:checked').forEach(function(cb) { filterConfig.linear_statuses.push(cb.value); });
        filterConfig.linear_priorities = [];
        filterLinearPriority.querySelectorAll('input[type="checkbox"]:checked').forEach(function(cb) { filterConfig.linear_priorities.push(parseInt(cb.value, 10)); });
        filterConfig.personal_statuses = [];
        filterPersonalStatus.querySelectorAll('input[type="checkbox"]:checked').forEach(function(cb) { filterConfig.personal_statuses.push(cb.value === '__empty__' ? '' : cb.value); });
      }

      function openFilterPopover() {
        populateFilterControls();
        syncPopoverFromFilterConfig();
        filterPopover.classList.add('open');
      }

      function closeFilterPopover() {
        filterPopover.classList.remove('open');
      }

      function populateFilterControls() {
        var linearStatuses = [];
        allIssues.forEach(function(i) {
          var s = (i.linear_status || '').trim();
          if (s && linearStatuses.indexOf(s) === -1) linearStatuses.push(s);
        });
        linearStatuses.sort();
        filterLinearStatus.innerHTML = linearStatuses.map(function(s) {
          return '<label><input type="checkbox" value="' + escapeHtml(s) + '"> ' + escapeHtml(s) + '</label>';
        }).join('');
        var priorityOrder = [1, 2, 3, 4, 0];
        filterLinearPriority.innerHTML = priorityOrder.map(function(p) {
          var label = priorityLabels[p] != null ? priorityLabels[p] : 'Priority ' + p;
          return '<label><input type="checkbox" value="' + p + '"> ' + escapeHtml(label) + '</label>';
        }).join('');
        filterPersonalStatus.innerHTML = (personalStatusOptions || []).map(function(o) {
          var val = (o === '' || o === undefined) ? '__empty__' : o;
          var display = (o === '' || o === undefined) ? 'No status' : o;
          return '<label><input type="checkbox" value="' + escapeHtml(val) + '"> ' + escapeHtml(display) + '</label>';
        }).join('');
      }

      function loadIssues(isRefresh) {
        hideError();
        setLoading(true);
        const filter = getFilter();
        let apiUrl = '/api/issues?filter=' + encodeURIComponent(filter) + '&sort=' + encodeURIComponent(sortColumn);
        if (sortColumn === 'last_updated') apiUrl += '&sort_dir=' + encodeURIComponent(sortDir);
        apiUrl += buildFilterQueryString(filterConfig);
        function onData(data) {
          if (data.error) throw new Error(data.error);
          allIssues = data.issues || [];
          if (data.last_fetched) lastFetchedEl.textContent = 'Last fetched: ' + formatDate(data.last_fetched);
          sortDir = (sortColumn === 'updated_at' || sortColumn === 'last_updated') ? 'desc' : 'asc';
          updateFilterBadge();
          updateSortIndicators();
          renderTable();
        }
        if (isRefresh) {
          fetch('/api/refresh', { method: 'POST' })
            .then(function(r) {
              if (!r.ok) return r.json().then(function(d) { throw new Error(d.error || r.statusText); });
              return r.json();
            })
            .then(function() { return fetch(apiUrl); })
            .then(function(r) {
              if (!r.ok) return r.json().then(function(d) { throw new Error(d.error || r.statusText); });
              return r.json();
            })
            .then(onData)
            .catch(function(err) {
              showError(err.message || 'Failed to load issues');
              tableEl.style.display = 'none';
              emptyEl.style.display = 'none';
            })
            .finally(function() { setLoading(false); });
        } else {
          fetch(apiUrl)
            .then(function(r) {
              if (!r.ok) return r.json().then(function(d) { throw new Error(d.error || r.statusText); });
              return r.json();
            })
            .then(onData)
            .catch(function(err) {
              showError(err.message || 'Failed to load issues');
              tableEl.style.display = 'none';
              emptyEl.style.display = 'none';
            })
            .finally(function() { setLoading(false); });
        }
      }

      function saveOverlay() {
        if (!editingIssueId) return;
        var priVal = modalPersonalPriority.value;
        var payload = {
          notes: modalNotes.value,
          personal_status: modalPersonalStatus.value,
          personal_priority: priVal === '' ? null : parseInt(priVal, 10)
        };
        if (payload.personal_priority !== null && isNaN(payload.personal_priority)) payload.personal_priority = null;
        fetch('/api/overlay/' + encodeURIComponent(editingIssueId), {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(payload)
        })
          .then(function(r) { return r.json(); })
          .then(function(data) {
            if (data.error) throw new Error(data.error);
            if (data.overlay) {
              Object.keys(data.overlay).forEach(function(key) {
                var issue = allIssues.find(function(i) { return (i.identifier || i.id) === key; });
                if (issue) {
                  var entry = data.overlay[key];
                  if (entry.personal_priority !== undefined) issue.personal_priority = entry.personal_priority;
                  if (entry.personal_status !== undefined) issue.personal_status = entry.personal_status;
                  if (entry.notes !== undefined) issue.notes = entry.notes;
                  if (entry.last_updated !== undefined) issue.last_updated = entry.last_updated;
                }
              });
            } else {
              var issue = allIssues.find(function(i) { return (i.identifier || i.id) === editingIssueId; });
              if (issue) {
                issue.notes = payload.notes;
                issue.personal_status = payload.personal_status;
                issue.personal_priority = payload.personal_priority;
                if (data.entry && data.entry.last_updated) issue.last_updated = data.entry.last_updated;
              }
            }
            closeModal();
            renderTable();
          })
          .catch(function(err) { showError(err.message || 'Failed to save'); });
      }

      filterBtn.addEventListener('click', function(e) {
        e.stopPropagation();
        if (filterPopover.classList.contains('open')) closeFilterPopover(); else openFilterPopover();
      });
      filterApplyBtn.addEventListener('click', function() {
        syncFilterConfigFromPopover();
        updateFilterBadge();
        closeFilterPopover();
        loadIssues(false);
      });
      filterClearBtn.addEventListener('click', function() {
        filterConfig = { date_from: '', date_to: '', linear_statuses: [], linear_priorities: [], personal_priority_filter: 'all', personal_statuses: [] };
        syncPopoverFromFilterConfig();
        updateFilterBadge();
        closeFilterPopover();
        loadIssues(false);
      });
      document.addEventListener('click', function(e) {
        if (filterPopover.classList.contains('open') && !filterPopover.contains(e.target) && !filterBtn.contains(e.target)) closeFilterPopover();
      });
      refreshBtn.addEventListener('click', function() { loadIssues(true); });
      tabActiveEl.addEventListener('click', function() {
        if (tabActiveEl.classList.contains('active')) return;
        tabActiveEl.classList.add('active');
        tabActiveEl.setAttribute('aria-selected', 'true');
        tabCompletedEl.classList.remove('active');
        tabCompletedEl.setAttribute('aria-selected', 'false');
        sortColumn = 'personal_priority';
        sortDir = 'asc';
        loadIssues(false);
      });
      tabCompletedEl.addEventListener('click', function() {
        if (tabCompletedEl.classList.contains('active')) return;
        tabCompletedEl.classList.add('active');
        tabCompletedEl.setAttribute('aria-selected', 'true');
        tabActiveEl.classList.remove('active');
        tabActiveEl.setAttribute('aria-selected', 'false');
        sortColumn = 'updated_at';
        sortDir = 'desc';
        loadIssues(false);
      });
      searchEl.addEventListener('input', renderTable);
      document.querySelectorAll('.th-sortable').forEach(function(th) {
        th.addEventListener('click', function() {
          var col = th.getAttribute('data-sort-column');
          if (!col) return;
          if (sortColumn === col) sortDir = sortDir === 'asc' ? 'desc' : 'asc';
          else { sortColumn = col; sortDir = 'asc'; if (col === 'updated_at' || col === 'last_updated') sortDir = 'desc'; }
          updateSortIndicators();
          renderTable();
        });
      });
      modalCancel.addEventListener('click', closeModal);
      modalSave.addEventListener('click', saveOverlay);
      modalEl.addEventListener('click', function(e) {
        if (e.target === modalEl) closeModal();
      });
      tbody.addEventListener('click', function(e) {
        var y = e.clientY;
        var x = e.clientX;
        var rows = tbody.querySelectorAll('tr');
        for (var i = 0; i < rows.length; i++) {
          var tr = rows[i];
          var trRect = tr.getBoundingClientRect();
          if (y < trRect.top || y > trRect.bottom) continue;
          var notesCell = tr.querySelector('.notes-cell');
          if (!notesCell) continue;
          var cellRect = notesCell.getBoundingClientRect();
          if (x >= cellRect.left && x <= cellRect.right && y >= cellRect.top && y <= cellRect.bottom) {
            var span = notesCell.querySelector('.notes-preview');
            if (span) openModal(span.getAttribute('data-issue-id'));
            break;
          }
        }
      });

      loadMeta();
      loadIssues(false);
    })();
  </script>
</body>
</html>
