<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>My Linear Dashboard{% if version %} v{{ version }}{% endif %}</title>
  <style>
    :root {
      --bg: #0f1419;
      --surface: #1a2332;
      --border: #2d3a4d;
      --text: #e6edf3;
      --text-muted: #8b949e;
      --link: #58a6ff;
      --priority-urgent: #f85149;
      --priority-high: #db6d28;
      --priority-medium: #d29922;
      --priority-low: #3fb950;
      --priority-none: #8b949e;
      --status-teal: #39c5cf;
      --status-purple: #a371f7;
      --status-amber: #d29922;
      --status-light-gray: #9ca3af;
      --status-desaturated-blue: #5b7c9a;
      --status-dark-red: #8b2e2e;
    }
    * { box-sizing: border-box; }
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
      background: var(--bg);
      color: var(--text);
      margin: 0;
      padding: 1rem 2rem 2rem;
      min-height: 100vh;
    }
    header {
      display: flex;
      align-items: center;
      gap: 1.5rem;
      flex-wrap: wrap;
      margin-bottom: 1.5rem;
      padding-bottom: 1rem;
      border-bottom: 1px solid var(--border);
    }
    h1 { margin: 0; font-size: 1.5rem; font-weight: 600; }
    .header-version { font-size: 1rem; font-weight: 500; color: var(--text-muted); }
    .last-fetched { color: var(--text-muted); font-size: 0.875rem; }
    button {
      background: var(--surface);
      color: var(--text);
      border: 1px solid var(--border);
      padding: 0.5rem 1rem;
      border-radius: 6px;
      cursor: pointer;
      font-size: 0.875rem;
    }
    button:hover { background: var(--border); }
    button.primary { background: var(--link); border-color: var(--link); color: #fff; }
    button.primary:hover { opacity: 0.9; }
    .controls {
      display: flex;
      gap: 1rem;
      flex-wrap: wrap;
      align-items: center;
      margin-bottom: 1rem;
    }
    .controls label { font-size: 0.875rem; color: var(--text-muted); }
    select, input[type="text"] {
      background: var(--surface);
      color: var(--text);
      border: 1px solid var(--border);
      padding: 0.4rem 0.6rem;
      border-radius: 4px;
      font-size: 0.875rem;
    }
    input[type="text"] { min-width: 200px; }
    table {
      width: 100%;
      border-collapse: collapse;
      font-size: 0.875rem;
    }
    th, td {
      padding: 0.6rem 0.75rem;
      text-align: left;
      border-bottom: 1px solid var(--border);
    }
    th { color: var(--text-muted); font-weight: 500; }
    tr.completed { opacity: 0.75; }
    tr.completed td { color: var(--text-muted); }
    a { color: var(--link); text-decoration: none; }
    a:hover { text-decoration: underline; }
    .badge {
      display: inline-block;
      padding: 0.2rem 0.5rem;
      border-radius: 4px;
      font-size: 0.75rem;
      font-weight: 500;
    }
    .priority-0 { background: var(--priority-none); color: var(--bg); }
    .priority-1 { background: var(--priority-urgent); color: #fff; }
    .priority-2 { background: var(--priority-high); color: #fff; }
    .priority-3 { background: var(--priority-medium); color: #000; }
    .priority-4 { background: var(--priority-low); color: #000; }
    .badge.personal-status-none { background: var(--status-light-gray); color: var(--bg); }
    .badge.personal-status-not-started { background: var(--status-desaturated-blue); color: #fff; }
    .badge.personal-status-in-progress { background: var(--link); color: #fff; }
    .badge.personal-status-testing { background: var(--status-teal); color: #000; }
    .badge.personal-status-pair-testing { background: var(--status-purple); color: #fff; }
    .badge.personal-status-waiting-on-testing { background: var(--status-amber); color: #000; }
    .badge.personal-status-waiting-on-someone { background: var(--status-amber); color: #000; }
    .badge.personal-status-waiting-on-me { background: var(--status-dark-red); color: #fff; }
    .badge.personal-status-waiting-on-review { background: var(--priority-low); color: #000; }
    .badge.personal-status-blocked { background: var(--priority-urgent); color: #fff; }
    .badge.personal-status-ready-to-close { background: var(--priority-low); color: #000; }
    .notes-cell { cursor: pointer; }
    .notes-preview {
      max-width: 220px;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
      color: var(--text-muted);
    }
    .notes-cell:hover .notes-preview { color: var(--link); text-decoration: underline; }
    .modal-overlay {
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.6);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 100;
    }
    .modal-overlay.open { display: flex; }
    .modal {
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: 8px;
      padding: 1.5rem;
      min-width: 400px;
      max-width: 90vw;
    }
    .modal h2 { margin: 0 0 1rem; font-size: 1.1rem; }
    .modal textarea {
      width: 100%;
      min-height: 100px;
      background: var(--bg);
      color: var(--text);
      border: 1px solid var(--border);
      border-radius: 4px;
      padding: 0.5rem;
      font-family: inherit;
      font-size: 0.875rem;
      margin-bottom: 1rem;
      resize: vertical;
    }
    .modal .field { margin-bottom: 0.75rem; }
    .modal .field label { display: block; font-size: 0.75rem; color: var(--text-muted); margin-bottom: 0.25rem; }
    .modal-actions { display: flex; justify-content: flex-end; gap: 0.5rem; margin-top: 1rem; }
    .loading, .empty { text-align: center; color: var(--text-muted); padding: 2rem; }
    .error { color: var(--priority-urgent); padding: 0.5rem 0; font-size: 0.875rem; }
    select.flat { border: none; background: transparent; color: inherit; cursor: pointer; padding: 0.2rem; }
    .tabs {
      display: flex;
      gap: 0;
      margin-bottom: 1rem;
      border-bottom: 1px solid var(--border);
    }
    .tab {
      background: transparent;
      border: none;
      border-bottom: 2px solid transparent;
      margin-bottom: -1px;
      padding: 0.5rem 1rem;
      font-size: 0.875rem;
      color: var(--text-muted);
      cursor: pointer;
    }
    .tab:hover { color: var(--text); }
    .tab.active {
      color: var(--link);
      border-bottom-color: var(--link);
      font-weight: 500;
    }
    .filter-btn-wrap { position: relative; display: inline-block; }
    .gear-wrap { margin-left: auto; }
    .filter-btn-wrap .filter-badge {
      position: absolute;
      top: -4px;
      right: -4px;
      min-width: 16px;
      height: 16px;
      padding: 0 4px;
      border-radius: 8px;
      background: var(--priority-urgent);
      color: #fff;
      font-size: 0.7rem;
      font-weight: 600;
      display: none;
      align-items: center;
      justify-content: center;
    }
    .filter-btn-wrap .filter-badge.visible { display: flex; }
    .filter-popover {
      position: absolute;
      top: 100%;
      left: 0;
      margin-top: 4px;
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: 8px;
      padding: 1rem;
      min-width: 280px;
      max-width: 90vw;
      box-shadow: 0 8px 24px rgba(0,0,0,0.4);
      z-index: 50;
      display: none;
    }
    .filter-popover.open { display: flex; flex-direction: column; max-height: min(70vh, 480px); }
    .filter-popover .filter-popover-scroll { flex: 1; min-height: 0; overflow-y: auto; }
    .filter-popover .filter-section { margin-bottom: 0.75rem; }
    .filter-popover .filter-section label { display: block; font-size: 0.75rem; color: var(--text-muted); margin-bottom: 0.25rem; }
    .filter-popover .filter-actions { display: flex; justify-content: flex-end; gap: 0.5rem; margin-top: 1rem; flex-shrink: 0; }
    .filter-popover input[type="date"] { background: var(--bg); color: var(--text); border: 1px solid var(--border); padding: 0.35rem; border-radius: 4px; font-size: 0.875rem; }
    .filter-popover .checkbox-list label { display: flex; align-items: center; gap: 0.5rem; font-size: 0.875rem; color: var(--text); margin: 0.25rem 0; cursor: pointer; }
    .filter-popover .checkbox-list input[type="checkbox"] { margin: 0; }
    .th-sortable { cursor: pointer; user-select: none; white-space: nowrap; }
    .th-sortable:hover { color: var(--text); }
    .th-sortable .sort-indicator { margin-left: 0.25rem; opacity: 0.7; }
    .column-popover { position: absolute; top: 100%; right: 0; left: auto; margin-top: 4px; background: var(--surface); border: 1px solid var(--border); border-radius: 8px; padding: 1rem; min-width: 260px; max-width: 90vw; box-shadow: 0 8px 24px rgba(0,0,0,0.4); z-index: 50; display: none; }
    .column-popover.open { display: block; }
    .column-popover .column-list { max-height: 280px; overflow-y: auto; }
    .column-popover .column-list label { display: flex; align-items: center; gap: 0.5rem; font-size: 0.875rem; color: var(--text); margin: 0.25rem 0; cursor: pointer; }
    .column-popover .column-list label.disabled { opacity: 0.7; cursor: default; }
    .column-popover .column-list input[type="checkbox"] { margin: 0; }
    .column-popover .column-row { display: flex; align-items: center; gap: 0.25rem; margin: 0.25rem 0; }
    .column-popover .column-order-btn { width: 1.5rem; height: 1.5rem; padding: 0; font-size: 0.7rem; line-height: 1; background: var(--surface); border: 1px solid var(--border); border-radius: 4px; color: var(--text); cursor: pointer; flex-shrink: 0; }
    .column-popover .column-order-btn:hover:not(:disabled) { background: var(--border); }
    .column-popover .column-order-btn:disabled { opacity: 0.5; cursor: not-allowed; }
    .column-popover .column-row label { flex: 1; margin: 0; }
    .column-popover .column-actions { margin-top: 0.75rem; }
    .column-popover .column-message { font-size: 0.75rem; color: var(--text-muted); margin-top: 0.25rem; }
    .label-badge { display: inline-block; padding: 0.15rem 0.4rem; border-radius: 4px; font-size: 0.7rem; margin-right: 0.25rem; margin-bottom: 0.15rem; }
  </style>
</head>
<body>
  <header>
    <h1>My Linear Dashboard{% if version %} <span class="header-version">v{{ version }}</span>{% endif %}</h1>
    <button type="button" id="refresh-btn">Refresh</button>
    <span class="last-fetched" id="last-fetched">Last fetched: —</span>
  </header>

  <div class="tabs" role="tablist">
    <button type="button" class="tab active" id="tab-active" role="tab" aria-selected="true">Active</button>
    <button type="button" class="tab" id="tab-completed" role="tab" aria-selected="false">Completed</button>
  </div>
  <div class="controls">
    <div class="filter-btn-wrap">
      <button type="button" id="filter-btn" title="Filter issues">
        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polygon points="22 3 2 3 10 12.46 10 19 14 21 14 12.46 22 3"/></svg>
      </button>
      <span class="filter-badge" id="filter-badge" aria-hidden="true"></span>
      <div class="filter-popover" id="filter-popover">
        <div class="filter-popover-scroll">
          <div id="filter-sections"></div>
        </div>
        <div class="filter-actions">
          <button type="button" id="filter-clear">Clear All</button>
          <button type="button" id="filter-apply" class="primary">Apply</button>
        </div>
      </div>
    </div>
    <label>Search:</label>
    <input type="text" id="search" placeholder="Title or notes...">
    <div class="filter-btn-wrap gear-wrap">
      <button type="button" id="gear-btn" title="Column visibility">
        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="3"/><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"/></svg>
      </button>
      <div class="column-popover" id="column-popover">
        <div class="column-list" id="column-list"></div>
        <div class="column-message" id="column-message" style="display: none;"></div>
        <div class="column-actions">
          <button type="button" id="column-reset">Reset to Default</button>
        </div>
      </div>
    </div>
  </div>

  <div id="error" class="error" style="display: none;"></div>
  <div id="loading" class="loading" style="display: none;">Loading…</div>
  <div id="empty" class="empty" style="display: none;">No issues match filters.</div>
  <table id="issues-table" style="display: none;">
    <thead>
      <tr id="issues-thead-row"></tr>
    </thead>
    <tbody id="issues-body"></tbody>
  </table>

  <div class="modal-overlay" id="modal">
    <div class="modal">
      <h2 id="modal-title">Edit overlay</h2>
      <div class="field">
        <label>Notes</label>
        <textarea id="modal-notes" placeholder="Private notes..."></textarea>
      </div>
      <div class="field">
        <label>Personal priority (position in list)</label>
        <select id="modal-personal-priority">
          <option value="">Not set</option>
        </select>
      </div>
      <div class="field">
        <label>Personal status</label>
        <select id="modal-personal-status"></select>
      </div>
      <div class="modal-actions">
        <button type="button" id="modal-cancel">Cancel</button>
        <button type="button" id="modal-save" class="primary">Save</button>
      </div>
    </div>
  </div>

  <script>
    (function() {
      let allIssues = [];
      let priorityLabels = {};
      let personalStatusOptions = [];
      let columns = [];
      let columnOrder = [];
      let columnVisibility = {};
      let editingIssueId = null;
      let filterConfig = {
        date_from: '',
        date_to: '',
        linear_statuses: [],
        linear_priorities: [],
        personal_priority_filter: 'all',
        personal_statuses: [],
        cycles: [],
        teams: [],
        labels: []
      };
      let sortColumn = 'personal_priority';
      let sortDir = 'asc';

      const lastFetchedEl = document.getElementById('last-fetched');
      const refreshBtn = document.getElementById('refresh-btn');
      const tabActiveEl = document.getElementById('tab-active');
      const tabCompletedEl = document.getElementById('tab-completed');
      const searchEl = document.getElementById('search');
      const errorEl = document.getElementById('error');
      const loadingEl = document.getElementById('loading');
      const emptyEl = document.getElementById('empty');
      const tableEl = document.getElementById('issues-table');
      const tbody = document.getElementById('issues-body');
      const modalEl = document.getElementById('modal');
      const gearBtn = document.getElementById('gear-btn');
      const columnPopover = document.getElementById('column-popover');
      const columnList = document.getElementById('column-list');
      const columnMessage = document.getElementById('column-message');
      const filterBtn = document.getElementById('filter-btn');
      const filterBadge = document.getElementById('filter-badge');
      const filterPopover = document.getElementById('filter-popover');
      const filterSections = document.getElementById('filter-sections');
      const filterClearBtn = document.getElementById('filter-clear');
      const filterApplyBtn = document.getElementById('filter-apply');
      const modalTitle = document.getElementById('modal-title');
      const modalNotes = document.getElementById('modal-notes');
      const modalPersonalPriority = document.getElementById('modal-personal-priority');
      const modalPersonalStatus = document.getElementById('modal-personal-status');
      const modalCancel = document.getElementById('modal-cancel');
      const modalSave = document.getElementById('modal-save');

      function showError(msg) {
        errorEl.textContent = msg;
        errorEl.style.display = 'block';
      }
      function hideError() {
        errorEl.style.display = 'none';
      }
      function setLoading(on) {
        loadingEl.style.display = on ? 'block' : 'none';
        if (!on) tableEl.style.display = 'table';
      }

      function formatDate(iso) {
        if (!iso) return '—';
        try {
          const d = new Date(iso);
          return d.toLocaleDateString(undefined, { dateStyle: 'short' });
        } catch (_) { return iso; }
      }

      function formatDateTime(iso) {
        if (!iso) return '—';
        try {
          const d = new Date(iso);
          return d.toLocaleString(undefined, { dateStyle: 'short', timeStyle: 'short' });
        } catch (_) { return iso; }
      }

      function formatAbsoluteDate(iso) {
        if (!iso) return '—';
        try {
          const d = new Date(iso);
          return d.toLocaleDateString(undefined, { year: 'numeric', month: 'short', day: 'numeric' });
        } catch (_) { return iso; }
      }

      function formatRelativeDate(iso) {
        if (!iso) return null;
        try {
          const d = new Date(iso);
          const now = new Date();
          const today = new Date(now.getFullYear(), now.getMonth(), now.getDate());
          const yesterday = new Date(today);
          yesterday.setDate(yesterday.getDate() - 1);
          const dDate = new Date(d.getFullYear(), d.getMonth(), d.getDate());
          if (dDate.getTime() === today.getTime()) return 'today';
          if (dDate.getTime() === yesterday.getTime()) return 'yesterday';
          const diffDays = Math.round((today - dDate) / (1000 * 60 * 60 * 24));
          if (diffDays > 0 && diffDays <= 7) return diffDays + ' days ago';
          return formatAbsoluteDate(iso);
        } catch (_) { return iso; }
      }

      function linearPriorityLabel(p) {
        return priorityLabels[p] != null ? priorityLabels[p] : '—';
      }
      function personalStatusBadgeClass(status) {
        var s = (status || '').trim();
        if (s === '') return 'none';
        return s.toLowerCase().replace(/\s+/g, '-');
      }

      function clientSortKeyLinearPriority(p) {
        var v = p != null ? p : 0;
        return v === 0 ? 5 : v;
      }
      function clientSortKeyPersonalPriority(issue, asc) {
        var p = issue.personal_priority;
        if (p == null || p === '') return asc ? 1e9 : -1e9;
        return p;
      }
      function clientSortKeyLastUpdated(issue, asc) {
        var lu = issue.last_updated || '';
        if (!lu) return asc ? 1 : 0;
        return asc ? lu : lu;
      }
      function sortIssuesClientSide(list, column, dir) {
        var asc = dir === 'asc';
        var arr = list.slice();
        if (column === 'identifier') {
          arr.sort(function(a, b) {
            var sa = (a.identifier || a.id || '').toString();
            var sb = (b.identifier || b.id || '').toString();
            var c = sa.localeCompare(sb);
            return asc ? c : -c;
          });
        } else if (column === 'title') {
          arr.sort(function(a, b) {
            var sa = (a.title || '').localeCompare(b.title || '');
            return asc ? sa : -sa;
          });
        } else if (column === 'linear_status') {
          arr.sort(function(a, b) {
            var sa = (a.linear_status || '').localeCompare(b.linear_status || '');
            return asc ? sa : -sa;
          });
        } else if (column === 'linear_priority') {
          arr.sort(function(a, b) {
            var ka = clientSortKeyLinearPriority(a.linear_priority);
            var kb = clientSortKeyLinearPriority(b.linear_priority);
            return asc ? (ka - kb) : (kb - ka);
          });
        } else if (column === 'personal_priority') {
          arr.sort(function(a, b) {
            var ka = clientSortKeyPersonalPriority(a, asc);
            var kb = clientSortKeyPersonalPriority(b, asc);
            return ka - kb;
          });
        } else if (column === 'personal_status') {
          arr.sort(function(a, b) {
            var sa = (a.personal_status || '').localeCompare(b.personal_status || '');
            return asc ? sa : -sa;
          });
        } else if (column === 'notes_preview') {
          arr.sort(function(a, b) {
            var sa = (a.notes || '').localeCompare(b.notes || '');
            return asc ? sa : -sa;
          });
        } else if (column === 'updated_at' || column === 'linear_updated') {
          arr.sort(function(a, b) {
            var ua = a.updated_at || '';
            var ub = b.updated_at || '';
            var c = ua.localeCompare(ub);
            return asc ? c : -c;
          });
        } else if (column === 'last_updated' || column === 'my_last_edit') {
          arr.sort(function(a, b) {
            var ua = a.last_updated || '';
            var ub = b.last_updated || '';
            if (!ua && !ub) return 0;
            if (!ua) return asc ? 1 : -1;
            if (!ub) return asc ? -1 : 1;
            var c = ua.localeCompare(ub);
            return asc ? c : -c;
          });
        } else if (column === 'cycle') {
          arr.sort(function(a, b) {
            var na = (a.cycle && a.cycle.name) ? a.cycle.name : '';
            var nb = (b.cycle && b.cycle.name) ? b.cycle.name : '';
            var c = na.localeCompare(nb);
            return asc ? c : -c;
          });
        } else if (column === 'team') {
          arr.sort(function(a, b) {
            var sa = (a.team_name || '').localeCompare(b.team_name || '');
            return asc ? sa : -sa;
          });
        } else if (column === 'labels') {
          arr.sort(function(a, b) {
            var la = (a.labels && a.labels[0]) ? (a.labels[0].name || '') : '';
            var lb = (b.labels && b.labels[0]) ? (b.labels[0].name || '') : '';
            var c = la.localeCompare(lb);
            return asc ? c : -c;
          });
        }
        return arr;
      }

      function filteredAndSortedIssues() {
        var q = (searchEl.value || '').trim().toLowerCase();
        var list = !q ? allIssues : allIssues.filter(function(issue) {
          var identifier = (issue.identifier || issue.id || '').toString().toLowerCase();
          var title = (issue.title || '').toLowerCase();
          var notes = (issue.notes || '').toLowerCase();
          return identifier.includes(q) || title.includes(q) || notes.includes(q);
        });
        return sortIssuesClientSide(list, sortColumn, sortDir);
      }

      function updateSortIndicators() {
        document.querySelectorAll('.th-sortable .sort-indicator').forEach(function(span) { span.textContent = ''; });
        var th = document.querySelector('.th-sortable[data-sort-column="' + sortColumn + '"]');
        if (th) {
          var ind = th.querySelector('.sort-indicator');
          if (ind) ind.textContent = sortDir === 'asc' ? ' ▲' : ' ▼';
        }
      }

      function renderTable() {
        var list = filteredAndSortedIssues();
        var visible = getVisibleColumns();
        tbody.innerHTML = '';
        if (list.length === 0) {
          emptyEl.style.display = 'block';
          tableEl.style.display = 'none';
          return;
        }
        emptyEl.style.display = 'none';
        list.forEach(function(issue) {
          var tr = document.createElement('tr');
          if (issue.is_completed) tr.classList.add('completed');
          visible.forEach(function(col) {
            var td = document.createElement('td');
            if (col.id === 'notes_preview') td.classList.add('notes-cell');
            td.innerHTML = cellContent(issue, col.id);
            tr.appendChild(td);
          });
          tbody.appendChild(tr);
        });
      }

      function escapeHtml(s) {
        if (s == null) return '';
        const div = document.createElement('div');
        div.textContent = s;
        return div.innerHTML;
      }

      function openModal(issueId) {
        const issue = allIssues.find(function(i) { return (i.identifier || i.id) === issueId; });
        if (!issue) return;
        editingIssueId = issueId;
        modalTitle.textContent = (issue.identifier || issueId) + ': ' + (issue.title || '');
        modalNotes.value = issue.notes || '';
        var count = allIssues.filter(function(i) { return i.personal_priority != null && i.personal_priority !== ''; }).length;
        var hasPriority = issue.personal_priority != null && issue.personal_priority !== '';
        var maxPos = hasPriority ? Math.max(count, 1) : Math.max(count + 1, 1);
        modalPersonalPriority.innerHTML = '<option value="">Not set</option>';
        for (var p = 1; p <= maxPos; p++) {
          var opt = document.createElement('option');
          opt.value = String(p);
          opt.textContent = p === 1 ? '1 (first)' : (p === maxPos ? p + ' (last)' : String(p));
          modalPersonalPriority.appendChild(opt);
        }
        modalPersonalPriority.value = issue.personal_priority != null && issue.personal_priority !== '' ? String(issue.personal_priority) : '';
        modalPersonalStatus.value = issue.personal_status || '';
        modalEl.classList.add('open');
      }

      function closeModal() {
        modalEl.classList.remove('open');
        editingIssueId = null;
      }

      function getOrderedColumns() {
        return columnOrder.map(function(id) { return columns.find(function(c) { return c.id === id; }); }).filter(Boolean);
      }

      function getVisibleColumns() {
        return getOrderedColumns().filter(function(c) { return columnVisibility[c.id]; });
      }

      function saveColumnPreferences() {
        fetch('/api/config/columns', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ order: columnOrder, visibility: columnVisibility })
        }).then(function(r) { return r.json(); }).then(function(data) {
          if (data.order) columnOrder = data.order;
          if (data.visibility) columnVisibility = data.visibility;
          buildThead();
          buildColumnPopover();
          buildFilterPopover();
          clearFiltersForHiddenColumns();
          updateFilterBadge();
          renderTable();
        }).catch(function() {});
      }

      function buildColumnPopover() {
        columnList.innerHTML = '';
        var ordered = getOrderedColumns();
        ordered.forEach(function(col, idx) {
          var row = document.createElement('div');
          row.className = 'column-row';
          var upBtn = document.createElement('button');
          upBtn.type = 'button';
          upBtn.className = 'column-order-btn';
          upBtn.setAttribute('aria-label', 'Move up');
          upBtn.textContent = '\u25B2';
          upBtn.disabled = idx === 0;
          upBtn.addEventListener('click', function() {
            if (idx === 0) return;
            var o = columnOrder.slice();
            o[idx] = o[idx - 1];
            o[idx - 1] = col.id;
            columnOrder = o;
            saveColumnPreferences();
          });
          var downBtn = document.createElement('button');
          downBtn.type = 'button';
          downBtn.className = 'column-order-btn';
          downBtn.setAttribute('aria-label', 'Move down');
          downBtn.textContent = '\u25BC';
          downBtn.disabled = idx === ordered.length - 1;
          downBtn.addEventListener('click', function() {
            if (idx === ordered.length - 1) return;
            var o = columnOrder.slice();
            o[idx] = o[idx + 1];
            o[idx + 1] = col.id;
            columnOrder = o;
            saveColumnPreferences();
          });
          var label = document.createElement('label');
          var disabled = (col.id === 'identifier' || col.id === 'title');
          if (disabled) label.classList.add('disabled');
          var cb = document.createElement('input');
          cb.type = 'checkbox';
          cb.dataset.columnId = col.id;
          cb.checked = columnVisibility[col.id];
          cb.disabled = disabled;
          cb.addEventListener('change', function() {
            if (disabled) return;
            var next = Object.assign({}, columnVisibility, { [col.id]: cb.checked });
            var visibleCount = Object.keys(next).filter(function(k) { return next[k]; }).length;
            if (visibleCount <= 2) {
              columnMessage.style.display = 'block';
              columnMessage.textContent = 'At least one column besides Issue and Title must remain visible.';
              cb.checked = true;
              return;
            }
            columnMessage.style.display = 'none';
            columnVisibility = next;
            saveColumnPreferences();
          });
          label.appendChild(cb);
          label.appendChild(document.createTextNode(' ' + col.label));
          row.appendChild(upBtn);
          row.appendChild(downBtn);
          row.appendChild(label);
          columnList.appendChild(row);
        });
      }

      function clearFiltersForHiddenColumns() {
        var visible = getVisibleColumns();
        var visibleIds = {};
        visible.forEach(function(c) { visibleIds[c.id] = true; });
        if (!visibleIds.linear_status) filterConfig.linear_statuses = [];
        if (!visibleIds.linear_priority) filterConfig.linear_priorities = [];
        if (!visibleIds.personal_priority) filterConfig.personal_priority_filter = 'all';
        if (!visibleIds.personal_status) filterConfig.personal_statuses = [];
        if (!visibleIds.linear_updated) { filterConfig.date_from = ''; filterConfig.date_to = ''; }
        if (!visibleIds.cycle) filterConfig.cycles = [];
        if (!visibleIds.team) filterConfig.teams = [];
        if (!visibleIds.labels) filterConfig.labels = [];
      }

      function buildFilterPopover() {
        filterSections.innerHTML = '';
        var visible = getVisibleColumns();
        var filterable = visible.filter(function(c) { return c.filterable; });
        filterable.forEach(function(col) {
          var section = document.createElement('div');
          section.className = 'filter-section';
          section.dataset.columnId = col.id;
          var labelEl = document.createElement('label');
          labelEl.textContent = col.label + (col.filter_type === 'daterange' ? ' — From' : '');
          section.appendChild(labelEl);
          if (col.filter_type === 'daterange' && col.id === 'linear_updated') {
            var fromInput = document.createElement('input');
            fromInput.type = 'date';
            fromInput.id = 'filter-date-from';
            section.appendChild(fromInput);
            var toLabel = document.createElement('label');
            toLabel.textContent = col.label + ' — To';
            toLabel.style.marginTop = '0.5rem';
            section.appendChild(toLabel);
            var toInput = document.createElement('input');
            toInput.type = 'date';
            toInput.id = 'filter-date-to';
            section.appendChild(toInput);
          } else if (col.filter_type === 'toggle' && col.id === 'personal_priority') {
            var sel = document.createElement('select');
            sel.id = 'filter-personal-priority';
            sel.innerHTML = '<option value="all">All</option><option value="set">Set</option><option value="unset">Unset</option>';
            section.appendChild(sel);
          } else if (col.filter_type === 'multiselect') {
            var listDiv = document.createElement('div');
            listDiv.className = 'checkbox-list';
            listDiv.id = 'filter-' + col.id;
            section.appendChild(listDiv);
          }
          filterSections.appendChild(section);
        });
        populateFilterControls();
      }

      function populateFilterControls() {
        var filterable = getVisibleColumns().filter(function(c) { return c.filterable; });
        filterable.forEach(function(col) {
          var listEl = document.getElementById('filter-' + col.id);
          if (!listEl || col.filter_type !== 'multiselect') return;
          listEl.innerHTML = '';
          var values = [];
          if (col.id === 'linear_status') {
            allIssues.forEach(function(i) {
              var s = (i.linear_status || '').trim();
              if (s && values.indexOf(s) === -1) values.push(s);
            });
            values.sort();
            values.forEach(function(s) {
              var label = document.createElement('label');
              var cb = document.createElement('input');
              cb.type = 'checkbox';
              cb.value = s;
              label.appendChild(cb);
              label.appendChild(document.createTextNode(' ' + s));
              listEl.appendChild(label);
            });
          } else if (col.id === 'linear_priority') {
            [1, 2, 3, 4, 0].forEach(function(p) {
              var label = document.createElement('label');
              var cb = document.createElement('input');
              cb.type = 'checkbox';
              cb.value = String(p);
              label.appendChild(cb);
              label.appendChild(document.createTextNode(' ' + (priorityLabels[p] || 'Priority ' + p)));
              listEl.appendChild(label);
            });
          } else if (col.id === 'personal_status') {
            (personalStatusOptions || []).forEach(function(o) {
              var label = document.createElement('label');
              var cb = document.createElement('input');
              cb.type = 'checkbox';
              cb.value = (o === '' || o === undefined) ? '__empty__' : o;
              label.appendChild(cb);
              label.appendChild(document.createTextNode(' ' + (o === '' || o === undefined ? 'No status' : o)));
              listEl.appendChild(label);
            });
          } else if (col.id === 'cycle') {
            allIssues.forEach(function(i) {
              var name = (i.cycle && i.cycle.name) ? i.cycle.name : '';
              if (name && values.indexOf(name) === -1) values.push(name);
            });
            values.sort();
            values.forEach(function(s) {
              var label = document.createElement('label');
              var cb = document.createElement('input');
              cb.type = 'checkbox';
              cb.value = s;
              label.appendChild(cb);
              label.appendChild(document.createTextNode(' ' + s));
              listEl.appendChild(label);
            });
          } else if (col.id === 'team') {
            allIssues.forEach(function(i) {
              var s = (i.team_name || '').trim();
              if (s && values.indexOf(s) === -1) values.push(s);
            });
            values.sort();
            values.forEach(function(s) {
              var label = document.createElement('label');
              var cb = document.createElement('input');
              cb.type = 'checkbox';
              cb.value = s;
              label.appendChild(cb);
              label.appendChild(document.createTextNode(' ' + s));
              listEl.appendChild(label);
            });
          } else if (col.id === 'labels') {
            allIssues.forEach(function(i) {
              (i.labels || []).forEach(function(lb) {
                var name = (lb.name || '').trim();
                if (name && values.indexOf(name) === -1) values.push(name);
              });
            });
            values.sort();
            values.forEach(function(s) {
              var label = document.createElement('label');
              var cb = document.createElement('input');
              cb.type = 'checkbox';
              cb.value = s;
              label.appendChild(cb);
              label.appendChild(document.createTextNode(' ' + s));
              listEl.appendChild(label);
            });
          }
        });
      }

      function buildThead() {
        var row = document.getElementById('issues-thead-row');
        if (!row) return;
        row.innerHTML = '';
        var visible = getVisibleColumns();
        visible.forEach(function(col) {
          var th = document.createElement('th');
          if (col.sortable) {
            th.className = 'th-sortable';
            th.setAttribute('data-sort-column', col.id);
            th.innerHTML = escapeHtml(col.label) + ' <span class="sort-indicator"></span>';
          } else {
            th.textContent = col.label;
          }
          row.appendChild(th);
        });
        updateSortIndicators();
      }

      function cellContent(issue, colId) {
        var id = issue.identifier || issue.id;
        if (colId === 'identifier') {
          return '<a href="' + (issue.url || '#') + '" target="_blank" rel="noopener">' + escapeHtml(id) + '</a>';
        }
        if (colId === 'title') {
          return escapeHtml(issue.title || '—');
        }
        if (colId === 'linear_status') {
          return escapeHtml(issue.linear_status || '—');
        }
        if (colId === 'linear_priority') {
          var p = issue.linear_priority != null ? issue.linear_priority : 0;
          var cls = 'priority-' + p;
          return '<span class="badge ' + cls + '">' + escapeHtml(linearPriorityLabel(issue.linear_priority)) + '</span>';
        }
        if (colId === 'personal_priority') {
          return (issue.personal_priority != null && issue.personal_priority !== '') ? String(issue.personal_priority) : 'Not set';
        }
        if (colId === 'personal_status') {
          var ps = issue.personal_status || '';
          var psLabel = ps === '' ? 'No status' : ps;
          var psBadgeClass = personalStatusBadgeClass(ps);
          return psBadgeClass ? '<span class="badge personal-status-' + escapeHtml(psBadgeClass) + '">' + escapeHtml(psLabel) + '</span>' : escapeHtml(psLabel);
        }
        if (colId === 'notes_preview') {
          var notesFirstLine = (issue.notes || '').split('\n')[0].trim();
          var notesPreview = notesFirstLine ? notesFirstLine.substring(0, 60) + (notesFirstLine.length > 60 ? '…' : '') : '';
          return '<span class="notes-preview" data-issue-id="' + escapeHtml(id) + '">' + escapeHtml(notesPreview || 'Add notes…') + '</span>';
        }
        if (colId === 'linear_updated') {
          var rel = formatRelativeDate(issue.updated_at);
          var tooltip = formatDateTime(issue.updated_at);
          return tooltip ? '<span title="' + escapeHtml(tooltip) + '">' + (rel || '—') + '</span>' : (rel || '—');
        }
        if (colId === 'my_last_edit') {
          var myEdit = issue.last_updated;
          if (!myEdit) return '—';
          var rel = formatRelativeDate(myEdit);
          var tooltip = formatDateTime(myEdit);
          return '<span title="' + escapeHtml(tooltip) + '">' + escapeHtml(rel) + '</span>';
        }
        if (colId === 'cycle') {
          var cycle = issue.cycle;
          var name = (cycle && cycle.name) ? cycle.name : '';
          return escapeHtml(name || '—');
        }
        if (colId === 'team') {
          return escapeHtml(issue.team_name || '—');
        }
        if (colId === 'labels') {
          var labels = issue.labels || [];
          if (labels.length === 0) return '—';
          return labels.map(function(lb) {
            var color = (lb.color && lb.color !== '') ? lb.color : '#8b949e';
            return '<span class="label-badge" style="background:' + escapeHtml(color) + ';color:#fff">' + escapeHtml(lb.name || '') + '</span>';
          }).join('');
        }
        return '—';
      }

      function loadMeta() {
        fetch('/api/priority-labels').then(function(r) { return r.json(); }).then(function(labels) {
          priorityLabels = labels;
        }).catch(function() {});
        fetch('/api/personal-status-options').then(function(r) { return r.json(); }).then(function(opts) {
          personalStatusOptions = opts || [];
          modalPersonalStatus.innerHTML = personalStatusOptions.map(function(o) {
            return '<option value="' + escapeHtml(o) + '">' + escapeHtml(o || 'No status') + '</option>';
          }).join('');
        }).catch(function() {});
        fetch('/api/config/columns').then(function(r) { return r.json(); }).then(function(data) {
          columns = data.columns || [];
          columnOrder = data.order && data.order.length === columns.length ? data.order : columns.map(function(c) { return c.id; });
          columnVisibility = data.visibility || {};
          buildThead();
          buildColumnPopover();
          buildFilterPopover();
          loadIssues(false);
        }).catch(function() { loadIssues(false); });
      }

      function getFilter() {
        return tabActiveEl.classList.contains('active') ? 'active' : 'completed';
      }

      function countActiveFilterCategories(cfg) {
        var n = 0;
        if ((cfg.date_from || '') !== '' || (cfg.date_to || '') !== '') n++;
        if ((cfg.linear_statuses || []).length > 0) n++;
        if ((cfg.linear_priorities || []).length > 0) n++;
        if ((cfg.personal_priority_filter || 'all') !== 'all') n++;
        if ((cfg.personal_statuses || []).length > 0) n++;
        if ((cfg.cycles || []).length > 0) n++;
        if ((cfg.teams || []).length > 0) n++;
        if ((cfg.labels || []).length > 0) n++;
        return n;
      }

      function buildFilterQueryString(cfg) {
        var parts = [];
        if ((cfg.date_from || '').trim()) parts.push('date_from=' + encodeURIComponent(cfg.date_from.trim()));
        if ((cfg.date_to || '').trim()) parts.push('date_to=' + encodeURIComponent(cfg.date_to.trim()));
        (cfg.linear_statuses || []).forEach(function(s) { parts.push('linear_status=' + encodeURIComponent(s)); });
        (cfg.linear_priorities || []).forEach(function(p) { parts.push('linear_priority=' + encodeURIComponent(String(p))); });
        if ((cfg.personal_priority_filter || 'all') !== 'all') parts.push('personal_priority_filter=' + encodeURIComponent(cfg.personal_priority_filter));
        (cfg.personal_statuses || []).forEach(function(s) { parts.push('personal_status=' + encodeURIComponent(s)); });
        (cfg.cycles || []).forEach(function(s) { parts.push('cycle=' + encodeURIComponent(s)); });
        (cfg.teams || []).forEach(function(s) { parts.push('team=' + encodeURIComponent(s)); });
        (cfg.labels || []).forEach(function(s) { parts.push('labels=' + encodeURIComponent(s)); });
        return parts.length ? '&' + parts.join('&') : '';
      }

      function updateFilterBadge() {
        var n = countActiveFilterCategories(filterConfig);
        filterBadge.textContent = n;
        if (n > 0) filterBadge.classList.add('visible'); else filterBadge.classList.remove('visible');
      }

      function syncPopoverFromFilterConfig() {
        var dateFrom = document.getElementById('filter-date-from');
        var dateTo = document.getElementById('filter-date-to');
        var personalPriority = document.getElementById('filter-personal-priority');
        if (dateFrom) dateFrom.value = filterConfig.date_from || '';
        if (dateTo) dateTo.value = filterConfig.date_to || '';
        if (personalPriority) personalPriority.value = filterConfig.personal_priority_filter || 'all';
        ['linear_status', 'linear_priority', 'personal_status', 'cycle', 'team', 'labels'].forEach(function(colId) {
          var listEl = document.getElementById('filter-' + colId);
          if (!listEl) return;
          var set = {};
          var arr = filterConfig[colId === 'linear_status' ? 'linear_statuses' : colId === 'linear_priority' ? 'linear_priorities' : colId === 'personal_status' ? 'personal_statuses' : colId + 's'] || [];
          if (colId === 'personal_status') {
            arr.forEach(function(s) { set[s === null || s === '' ? '__empty__' : s] = true; });
          } else {
            arr.forEach(function(s) { set[String(s)] = true; });
          }
          listEl.querySelectorAll('input[type="checkbox"]').forEach(function(cb) {
            cb.checked = set[cb.value] || false;
          });
        });
      }

      function syncFilterConfigFromPopover() {
        var dateFrom = document.getElementById('filter-date-from');
        var dateTo = document.getElementById('filter-date-to');
        var personalPriority = document.getElementById('filter-personal-priority');
        if (dateFrom) filterConfig.date_from = (dateFrom.value || '').trim();
        if (dateTo) filterConfig.date_to = (dateTo.value || '').trim();
        if (personalPriority) filterConfig.personal_priority_filter = personalPriority.value || 'all';
        filterConfig.linear_statuses = [];
        var ls = document.getElementById('filter-linear_status');
        if (ls) ls.querySelectorAll('input[type="checkbox"]:checked').forEach(function(cb) { filterConfig.linear_statuses.push(cb.value); });
        filterConfig.linear_priorities = [];
        var lp = document.getElementById('filter-linear_priority');
        if (lp) lp.querySelectorAll('input[type="checkbox"]:checked').forEach(function(cb) { filterConfig.linear_priorities.push(parseInt(cb.value, 10)); });
        filterConfig.personal_statuses = [];
        var ps = document.getElementById('filter-personal_status');
        if (ps) ps.querySelectorAll('input[type="checkbox"]:checked').forEach(function(cb) { filterConfig.personal_statuses.push(cb.value === '__empty__' ? '' : cb.value); });
        filterConfig.cycles = [];
        var cy = document.getElementById('filter-cycle');
        if (cy) cy.querySelectorAll('input[type="checkbox"]:checked').forEach(function(cb) { filterConfig.cycles.push(cb.value); });
        filterConfig.teams = [];
        var tm = document.getElementById('filter-team');
        if (tm) tm.querySelectorAll('input[type="checkbox"]:checked').forEach(function(cb) { filterConfig.teams.push(cb.value); });
        filterConfig.labels = [];
        var lb = document.getElementById('filter-labels');
        if (lb) lb.querySelectorAll('input[type="checkbox"]:checked').forEach(function(cb) { filterConfig.labels.push(cb.value); });
      }

      function openFilterPopover() {
        populateFilterControls();
        syncPopoverFromFilterConfig();
        filterPopover.classList.add('open');
      }

      function closeFilterPopover() {
        filterPopover.classList.remove('open');
      }

      function loadIssues(isRefresh) {
        hideError();
        setLoading(true);
        const filter = getFilter();
        let apiUrl = '/api/issues?filter=' + encodeURIComponent(filter) + '&sort=' + encodeURIComponent(sortColumn);
        if (sortColumn === 'last_updated' || sortColumn === 'my_last_edit' || sortColumn === 'linear_updated' || sortColumn === 'updated_at') apiUrl += '&sort_dir=' + encodeURIComponent(sortDir);
        apiUrl += buildFilterQueryString(filterConfig);
        function onData(data) {
          if (data.error) throw new Error(data.error);
          allIssues = data.issues || [];
          if (data.last_fetched) lastFetchedEl.textContent = 'Last fetched: ' + formatDate(data.last_fetched);
          sortDir = (sortColumn === 'updated_at' || sortColumn === 'last_updated' || sortColumn === 'linear_updated' || sortColumn === 'my_last_edit') ? 'desc' : 'asc';
          updateFilterBadge();
          updateSortIndicators();
          renderTable();
        }
        if (isRefresh) {
          fetch('/api/refresh', { method: 'POST' })
            .then(function(r) {
              if (!r.ok) return r.json().then(function(d) { throw new Error(d.error || r.statusText); });
              return r.json();
            })
            .then(function() { return fetch(apiUrl); })
            .then(function(r) {
              if (!r.ok) return r.json().then(function(d) { throw new Error(d.error || r.statusText); });
              return r.json();
            })
            .then(onData)
            .catch(function(err) {
              showError(err.message || 'Failed to load issues');
              tableEl.style.display = 'none';
              emptyEl.style.display = 'none';
            })
            .finally(function() { setLoading(false); });
        } else {
          fetch(apiUrl)
            .then(function(r) {
              if (!r.ok) return r.json().then(function(d) { throw new Error(d.error || r.statusText); });
              return r.json();
            })
            .then(onData)
            .catch(function(err) {
              showError(err.message || 'Failed to load issues');
              tableEl.style.display = 'none';
              emptyEl.style.display = 'none';
            })
            .finally(function() { setLoading(false); });
        }
      }

      function saveOverlay() {
        if (!editingIssueId) return;
        var priVal = modalPersonalPriority.value;
        var payload = {
          notes: modalNotes.value,
          personal_status: modalPersonalStatus.value,
          personal_priority: priVal === '' ? null : parseInt(priVal, 10)
        };
        if (payload.personal_priority !== null && isNaN(payload.personal_priority)) payload.personal_priority = null;
        fetch('/api/overlay/' + encodeURIComponent(editingIssueId), {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(payload)
        })
          .then(function(r) { return r.json(); })
          .then(function(data) {
            if (data.error) throw new Error(data.error);
            if (data.overlay) {
              Object.keys(data.overlay).forEach(function(key) {
                var issue = allIssues.find(function(i) { return (i.identifier || i.id) === key; });
                if (issue) {
                  var entry = data.overlay[key];
                  if (entry && typeof entry === 'object' && !Array.isArray(entry)) {
                    issue.personal_priority = entry.hasOwnProperty('personal_priority') ? entry.personal_priority : undefined;
                    if (entry.personal_status !== undefined) issue.personal_status = entry.personal_status;
                    if (entry.notes !== undefined) issue.notes = entry.notes;
                    if (entry.last_updated !== undefined) issue.last_updated = entry.last_updated;
                  }
                }
              });
            } else {
              var issue = allIssues.find(function(i) { return (i.identifier || i.id) === editingIssueId; });
              if (issue) {
                issue.notes = payload.notes;
                issue.personal_status = payload.personal_status;
                issue.personal_priority = payload.personal_priority;
                if (data.entry && data.entry.last_updated) issue.last_updated = data.entry.last_updated;
              }
            }
            closeModal();
            renderTable();
          })
          .catch(function(err) { showError(err.message || 'Failed to save'); });
      }

      filterBtn.addEventListener('click', function(e) {
        e.stopPropagation();
        if (filterPopover.classList.contains('open')) closeFilterPopover(); else openFilterPopover();
      });
      filterApplyBtn.addEventListener('click', function() {
        syncFilterConfigFromPopover();
        updateFilterBadge();
        closeFilterPopover();
        loadIssues(false);
      });
      filterClearBtn.addEventListener('click', function() {
        filterConfig = { date_from: '', date_to: '', linear_statuses: [], linear_priorities: [], personal_priority_filter: 'all', personal_statuses: [], cycles: [], teams: [], labels: [] };
        syncPopoverFromFilterConfig();
        updateFilterBadge();
        closeFilterPopover();
        loadIssues(false);
      });
      document.addEventListener('click', function(e) {
        if (filterPopover.classList.contains('open') && !filterPopover.contains(e.target) && !filterBtn.contains(e.target)) closeFilterPopover();
        if (columnPopover.classList.contains('open') && !columnPopover.contains(e.target) && !gearBtn.contains(e.target)) columnPopover.classList.remove('open');
      });
      gearBtn.addEventListener('click', function(e) {
        e.stopPropagation();
        columnPopover.classList.toggle('open');
        columnMessage.style.display = 'none';
      });
      document.getElementById('column-reset').addEventListener('click', function() {
        columnOrder = columns.map(function(c) { return c.id; });
        columnVisibility = {};
        columns.forEach(function(c) { columnVisibility[c.id] = c.default_visible; });
        saveColumnPreferences();
      });
      refreshBtn.addEventListener('click', function() { loadIssues(true); });
      tabActiveEl.addEventListener('click', function() {
        if (tabActiveEl.classList.contains('active')) return;
        tabActiveEl.classList.add('active');
        tabActiveEl.setAttribute('aria-selected', 'true');
        tabCompletedEl.classList.remove('active');
        tabCompletedEl.setAttribute('aria-selected', 'false');
        sortColumn = 'personal_priority';
        sortDir = 'asc';
        loadIssues(false);
      });
      tabCompletedEl.addEventListener('click', function() {
        if (tabCompletedEl.classList.contains('active')) return;
        tabCompletedEl.classList.add('active');
        tabCompletedEl.setAttribute('aria-selected', 'true');
        tabActiveEl.classList.remove('active');
        tabActiveEl.setAttribute('aria-selected', 'false');
        sortColumn = 'updated_at';
        sortDir = 'desc';
        loadIssues(false);
      });
      searchEl.addEventListener('input', renderTable);
      tableEl.addEventListener('click', function(e) {
        var th = e.target.closest('.th-sortable');
        if (!th) return;
        var col = th.getAttribute('data-sort-column');
        if (!col) return;
        if (sortColumn === col) sortDir = sortDir === 'asc' ? 'desc' : 'asc';
        else { sortColumn = col; sortDir = 'asc'; if (col === 'updated_at' || col === 'last_updated' || col === 'linear_updated' || col === 'my_last_edit') sortDir = 'desc'; }
        updateSortIndicators();
        renderTable();
      });
      modalCancel.addEventListener('click', closeModal);
      modalSave.addEventListener('click', saveOverlay);
      modalEl.addEventListener('click', function(e) {
        if (e.target === modalEl) closeModal();
      });
      tbody.addEventListener('click', function(e) {
        var y = e.clientY;
        var x = e.clientX;
        var rows = tbody.querySelectorAll('tr');
        for (var i = 0; i < rows.length; i++) {
          var tr = rows[i];
          var trRect = tr.getBoundingClientRect();
          if (y < trRect.top || y > trRect.bottom) continue;
          var notesCell = tr.querySelector('.notes-cell');
          if (!notesCell) continue;
          var cellRect = notesCell.getBoundingClientRect();
          if (x >= cellRect.left && x <= cellRect.right && y >= cellRect.top && y <= cellRect.bottom) {
            var span = notesCell.querySelector('.notes-preview');
            if (span) openModal(span.getAttribute('data-issue-id'));
            break;
          }
        }
      });

      loadMeta();
    })();
  </script>
</body>
</html>
